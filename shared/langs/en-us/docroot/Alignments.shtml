<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Alignments</title>

  <link rel="stylesheet" href="lib/curriculum.css" />
    <script src="lib/bootstraplesson.js"></script>
    <script src="lib/dictionaries.js"></script>
    <script src="dependency-graph.js"></script>
    <script src="pathway-tocs.js"></script>
    <script>
      let lessonMap = {};
      Object.values(graph).forEach(lesson => lessonMap[lesson.title] = {});

      function populateByLesson() {
        const { pathway, lessons } = getParams();
        const dictParent = document.querySelector('#content');
        let alignedLessons = lessons || pathwayTocs[pathway] || Object.keys(graph)
          .filter(onlyUnique)
          .sort((a,b) => a.title < b.title? -1 : 1);
        
        let html = '<div class="dlist alignedStandards"><dl>';
        alignedLessons.forEach(l => {
          const {title, description} = graph[l];
          const alignedStandards = lessonMap[title];
          html += `<dt>${title}</dt>`
          if(!alignedStandards) {
            html += `<dd>No Alignments for this Lesson</dd>`; 
          } else {
            const list = [...Object.keys(alignedStandards)].sort().map(k => 
              `<li><b>${k}</b> : ${alignedStandards[k].join(", ")}</li>`);
            html+=`<dd><ul>${list.join('')}</ul></dd>`;  
          }
        })
        html += '</dl></div>';
        dictParent.innerHTML = html;
      }

      function populateByAlignment() {
        const { pathway, lessons } = getParams();
        let alignedLessons = lessons || pathwayTocs[pathway] || Object.keys(graph);
        const normalizedAlignedLessons = alignedLessons.map(removeProglangSuffix);

        // get DOM for alignment parent and alignment dropdown menu
        const dictParent = document.querySelector('#content');
        const dropdown = document.getElementsByClassName('alignmentSelect')[0];
        const url = new URL(location);

        // add a group of standards to the page
        function addGroup(keyName, groupLabel) {
          // add the dropdown optgroup
          const group = document.createElement('optgroup');
          group.label = groupLabel;

          // Walk over dictionaries, adding an alignment div for each
          for( const [dict, entries] of Object.entries(dictionaries[keyName]) ) {
            let {fullname, url:stdUrl} = entries['__metadata'];
            // build the alignment div, and add a dictionary list to it
            const div = document.createElement('div');
            div.classList.add('dlist', 'alignedStandards', keyName+'-'+dict);
            div.innerHTML = `<div class="title">
              <h2><a href="${stdUrl}">${fullname}</a></h2>
            </div><dl></dl>`;
            const list = div.querySelector('dl')

            // Walk over entries, adding each to the list if it aligns with the current lesson
            // OR if there's a lesson in the current pathway or graph that aligns to it
            // SKIP __metadata, which does not contain a 'lessons' field
            for( const [id, entry] of Object.entries(entries) ) {
              if(entry.lessons && entry.lessons.filter(l => normalizedAlignedLessons.includes(l)).length) {
                list.innerHTML += `<dt>${id}</dt>`;
                // if there are aligned standards,
                // add all lessons (and links!) to the description
                var relevantLessons = alignedLessons.filter(l => entry.lessons.includes(removeProglangSuffix(l)));
                // if we're not aligned to any specific pathway or lesson, remove suffixed duplicates
                if(!pathway && !lessons) {
                  relevantLessons = relevantLessons.filter(l => removeProglangSuffix(l) == l);
                }
                entry.description += " [See: ";
                entry.description += relevantLessons.map(l =>
                    `<a href="lessons/${l}/index.shtml${url.search}">${graph[l].title}</a>`)
                  .join(", ");
                entry.description += "]";
                list.innerHTML += `<dd><p>${entry.description}</p></dd>`;
                // build the lessonMap, adding every standard to every dictionary-array
                relevantLessons.forEach(l => {
                  let map = lessonMap[graph[l].title];
                  if(!map[fullname]) { map[fullname] = []; } // first time we've seen this dict!
                  map[fullname].push(id);
                })
              }
            }
            div.appendChild(list);
            dictParent.append(div);

            // if we actually have alignments and they aren't state-specific, 
            // add them to the page and optgroup
            if (list.children.length > 0 && !stateMap.get(dict)) {
              const opt = document.createElement('option');
              opt.value = keyName + '-' + dict;
              opt.appendChild(document.createTextNode(fullname));
              group.append(opt);
            }
          }
          
          // add non-empty groups to the dropdown
          if (group.children.length > 0) {
            dropdown.appendChild(group);
          }
        }

        // Add Menu Groups for all the built-in alignment dictionaries
        addGroup("standards", "By Standard");
        addGroup("practices", "By Practice");
        addGroup("textbooks", "By Textbook");

        // Add Menu Group for states
        const stateGroup = document.createElement('optgroup');
        stateGroup.label = "By State";
        [...stateMap.entries()].forEach(entry => {
          const opt = document.createElement('option');
          opt.value = 'standards-'+entry[0]; 
          opt.appendChild(document.createTextNode(entry[1]));
          stateGroup.appendChild(opt);
        });
        dropdown.appendChild(stateGroup);
      }
      
    </script>
</head>
<body class="narrativepage article" onLoad="populateByAlignment(); showAlignment('standards-CCSS-Math');">
  <!--#include virtual="/menubar.ssi"-->
  <div id="body">
    <div id="header">
      <h1>Alignments</h1>
    </div>
    <div id="content">
      <div class="paragraph">
        <p>
          <div class="standard-menu-container"><div>
          Bootstrap lessons align with several important teaching standards, textbooks, and practices. Select from the following menu to see which lessons meet those alignments.
        </p>
        <div><select class="alignmentSelect" onchange="showAlignment(this.value)"></select></div>
      </div>
    </div>
  </div>
</body>
</html>