= Table Methods

@lesson-description{Students learn about _table methods_, which allow them to order, filter, and build columns to extend the animals table.}

@add-to-lang{.order-by, .filter, .build-column}


[@lesson-intro-table]
|===
@prereqs-stds{defining-functions}
| Lesson Goals
| Students will be able to...

* order the Animals Dataset by a number of criteria
* filter the Animals Dataset by species, fixed status, and age
* add a column to the Animals Dataset

| Student-facing Lesson Goals
|

* Let’s learn how to start with one table and transform it into another.

| Materials
|[.materials-links]
* @link{https://docs.google.com/presentation/d/1EZp_E7MUNi6fdYplzMKcwIrRigdPX4N-B1gdtSCSJ5M/, Lesson Slides}
* @link{https://code.pyret.org/editor#share=1JPuXrbW20rXvuHl0logkDNTy62XXc7qv, Table Methods Starter File}
*  @link{pages/function-cards.adoc, Function Cards - Print and cut!}

@material-links

| Preparation
|
* Make sure all materials have been gathered
* Decide how students will be grouped in pairs
* Computer for each student (or pair), with access to the internet
* link:{pathwayrootdir}/workbook/workbook.pdf[Student workbook], and something to write with
@ifproglang{pyret}{
* All students should log into @link{https://code.pyret.org, CPO} and open the @link{https://code.pyret.org/editor#share=1JPuXrbW20rXvuHl0logkDNTy62XXc7qv, Table Methods Starter File}}

@lang-prereq
|===

== Introducing Function Definitions @duration{15 minutes}

=== Overview
@ifproglang{pyret}{
Students review row definitions, and are _introduced_ to Function Definitions in Pyret, and do some open-ended reading and interpreting of code.}
@ifproglang{codap}{
Students sort a column on a table by actually _changing_ the table.}

=== Launch
@ifproglang{pyret}{
Load the @link{https://code.pyret.org/editor#share=1JPuXrbW20rXvuHl0logkDNTy62XXc7qv, Table Methods Starter File}, go to the File menu, and click "Save a Copy".

This program has several things you've never seen before! This activity is about reading carefully, and trying to make sense of new code.}

@ifproglang{codap}{Open `Animals Dataset` in CODAP. You're going to sort various columns on the table by clicking on the attribute name, and selecting from the drop-down menu either `Sort Ascending` or `Sort Descending`.}

=== Investigate

Student work in groups or pairs.

[.lesson-instruction]
@ifproglang{pyret}{
- Complete @printable-exercise{pages/row-and-function-definitions.adoc} in their student workbooks.
- Complete @printable-exercise{pages/exploring-definitions.adoc} in their student workbooks.

Take a look at the three examples for `is-dog`. Each one shows us a different way of thinking about examples, in this case using a row that should return `false`:

. The first example tells us that we should expect `is-dog` to return `false`. We defined this row to be a cat, so we want to see a `false` result!
. The second example shows us some of the work involved: we know the species of the row is `"cat"`, and comparing that to the String `"dog"` will return false.
. The third example shows __all the work__: given the `cat-row`, we lookup the value in the `"species"` column and compare it to the String `"dog"`.

[.lesson-instruction]
Optional: Add three _true_ examples for `is-dog`, this time using the `dog-row` you defined above.
}

@ifproglang{codap}{
- Sort the animals alphabetically by name.
- Sort the animals by age, from youngest to oldest.
- Sort the animals from heaviest to lightest.
- Sort the animals table by how long it took for each animal to be adopted, in ascending order.}

=== Synthesize
@ifproglang{pyret}{
. Have students explain what each function does. Challenge them to use terminology like "looks up the value in the X column" when describing a lookup.

. Have students explain what is going on for `image-scatter-plot`. The critical point is that `image-scatter-plot` *consumes a function*. This is a big deal, and is critical to the activities that follow!}

@ifproglang{codap}{
. Can you think of a situation when it would be useful to sort animals from heaviest to lightest?

. Does sorting `animals-table` produce a _new_ table, or change the existing one? How do you know?

. Can you think of a situation where CODAP's default behavior - to alter the table each time we sort it - might inhibit more sophisticated data analysis?}

== Ordering Tables @duration{10 minutes}

=== Overview
@ifproglang{pyret}{
Students learn to sort rows of a table in ascending or descending order, according to one column.}

@ifproglang{codap}{
Using the `sort` transformer, students sort rows of a table in ascending or descending order, according to one column. When they use transformers, students are building and modifying a _copy_ of the original table.}

=== Launch
@ifproglang{pyret}{
Have students find the contract for `.order-by` in their contracts pages. The `.order-by` method consumes a String (the name of the column by which we want to order) and a Boolean (true for ascending, false for descending). But what does it produce?}

@ifproglang{codap}{
The transformers plugin allows students to transform datasets to produce new, distinct output datasets or values, instead of modifying the original input dataset itself. Have students find the contract for the `sort` transformer in their contracts pages. The `sort` method consumes a dataset to sort, a formula (“key expression”), an indication of the type the formula evaluates to, and a sort direction (ascending or descending). But what does it produce?


[.strategy-box, cols="1a", grid="none", stripes="none"]
|===
a|
@span{.title}{What's a Contract!?}
Contracts help us keep track of the different Transformers we'll be using. Every contract has three imporant parts:

. The transformer’s name
. The domain of the transformer - the type(s) of data we give it
. The range of the transformer - the type of data the transformer produces

Check out the screenshot of the Transformers plugin below. What are the domain and range for `Filter`?

@centered-image{images/transformer-contract-example.png,"" ,300}

Can you find a transformer that has `boolean` as its range? The transformer `mean` doesn't display a contract. What type of data do you think `mean` must consume? Why?

|===
}
=== Investigate
[.lesson-instruction]
@ifproglang{pyret}{
* Type `animals-table.order-by("name", true)` into the Interactions Area. What do you get?
* Type `animals-table.order-by("age", false)` into the Interactions Area. What do you get?
* Sort the animals table from heaviest to lightest.
* Sort the animals table alphabetically by species.
* Sort the animals table by how long it took for each animal to be adopted, in ascending order.}

@ifproglang{codap}{
* Open the `Transformer` plugin, and choose the transformer `Sort`. Select `animals-dataset`. In the formula expression box, type `sortItems(Name)`. Select `ascending` as the direction. What happens?
* Next, see what happens when you select `descending`.
* Sort the animals table from heaviest to lightest.
* Sort the animals table alphabetically by species.
* Sort the animals table by how long it took for each animal to be adopted, in ascending order.}

=== Synthesize
@ifproglang{pyret}{
- What do `.order-by` and `.row-n` have in common? How are they different?
- Does sorting the `animals-table` produce a _new_ table, or change the existing one? How could we test this?}

@ifproglang{codap}{
- Does the transformer `Sort` produce a _new_ table, or change the existing one?
- You've now learned two different strategies for sorting a column of a table. What do the two strategies have in common? How are they different?}

== Filtering Tables @duration{20 minutes}

=== Overview
Students learn how to _filter_ tables by removing Rows.

=== Launch
@ifproglang{pyret}{
Explain to students that you have "Function Cards", which describe the purpose statement of a function that consumes a Row from a table of students, and produces a Boolean (e.g. - "this student is wearing glasses"). Select a volunteer to be the @ifproglang{pyret}{"filter method"} @ifproglang{codap}{"filter transformer"}, and have them _randomly choose_ a @link{pages/function-cards.adoc, Function Card}, and make sure they read it without showing it to anyone else.

Have 6-8 students line up in front of the classroom, and have the filter @ifproglang{pyret}{method} @ifproglang{codap}{transformer} go to each student and say "stay" or "sit" depending on whether their function would return true or false for that student. If they say "sit", the student sits down. If they say "stay", the student stays standing.

Ask the class: based on who sat and who stayed, _what function was on the card?_}

[.lesson-point]
@ifproglang{pyret}{
The `.filter` method takes a _function_, and produces a new table containing only rows for which the function returns `true`.

Suppose we want to get a table of only animals that have been fixed? Have students find the contract for `.filter` in their contracts pages. The `.filter` method is taking in a _function_. What is the contract for that function? Where have we seen functions-taking-functions before?}

@ifproglang{codap}{
The `Filter` transformer takes a dataset and produces a copy of it that contains only the cases for which the given formula evaluates to true.

Suppose we want to get a table of only animals that have been fixed? Have students find the contract for `Filter` in their contracts pages. The `Filter` transformer consumes a dataset to filter and a formula that evaluates to either true or false.}

=== Investigate

[.lesson-instruction]
@ifproglang{pyret}{
* In the Interactions Area, type `animals-table.filter(lookup-fixed)`. What did you get?
* What do you expect `animals-table` to produce, and why? Try it out. What happened?
* In the Interactions Area, type `animals-table.filter(is-old)`. What did you get?
* In the Interactions Area, type `animals-table.filter(is-dog)`. What did you get?
* In the Interactions Area, type `animals-table.filter(lookup-name)`. What did you get?

The `.filter` method walks through the table, applying whatever function it was given to each row, and producing a new table containing all the rows for which the function returned `true`. Notice that the Domain for `.filter` says that test must be a function (that’s the arrow), which consumes a `Row` and produces a `Boolean`. If it consumes anything besides a single `Row`, or if it produces anything else besides a `Boolean`, we'll get an error.}

@ifproglang{codap}{
* Open the `Transformer` plugin, and choose the transformer `Filter`. Select `animals-dataset`. In the formula expression box, type `Fixed = “TRUE”`. Apply the transformer. What happens?
* Does CODAP mind if you forget to capitalize? What about if you leave out quotation marks?  Examine the error messages that appear if you are just a little careless as you enter text into the formula expression box.
* This time, in the formula expression box, type `Age > 5`. What did you get?
* Now try `Species = “dog”`

The `Filter` transformer walks through the table, applying whatever function it was given to each row, and producing a new table containing all the rows for which the function returned `true`. Notice that the Domain for `Filter` says that test must be a formula, which consumes a `Row` and produces a `Boolean`. If it consumes anything besides a single `Row`, or if it produces anything else besides a `Boolean`, we'll get an error.}

=== Common Misconceptions
@ifproglang{pyret}{
Students often think that filtering a table _changes_ the table. In Pyret, all table methods produce a _brand new table_. If we want to save that table, we need to define it. For example: `cats = animals-table.filter(is-cat)`.}

@ifproglang{codap}{
Students may be more familiar with filters that actually change the table. In CODAP, all transformers produce a _brand new table_. Filtered tables are automatically saved; CODAP titles each new table `Filter(Animals-Dataset) {1}` - with the number in curly braces indicating how many times the transformer has been applied. Students can also rename saved tables, if they’d like.}

=== Synthesize
Debrief with students. Some guiding questions on filtering:

- Suppose we wanted to determine whether cats or dogs get adopted faster. How might using the `.filter` @ifproglang{pyret}{method} @ifproglang{codap}{transformer} help?
- If the shelter is purchasing food for older cats, what filter would we write to determine how many cats to buy for?
- Can you think of a situation where filtering fixed animals would be helpful?

== Building Columns @duration{10 minutes}

=== Overview
Students learn how to _build columns_, @ifproglang{pyret}{ using the `.build-column` table method} @ifproglang{codap}{using the `Build Attribute` transformer}.

=== Launch
Suppose we want to _transform_ our table, converting `pounds` to `kilograms` or `weeks` to `days`. Have students find the contract for @ifproglang{pyret}{`.build-column`} @ifproglang{codap}{`Build Attribute`} in their contracts pages. @ifproglang{pyret}{The `.build-column` method is taking in a _function_ and a _string_. What is the contract for that function?} @ifproglang{codap}{The `Build Attribute` transformer makes a new copy of a dataset, and adds a new attribute. We must provide a dataset, a name for the new attribute, an existing collection to add the attribute to, a formula for the attribute’s values, and an indication of the type of value the formula will evaluate to.}

=== Investigate
[.lesson-instruction]
@ifproglang{pyret}{
* Try typing `animals-table.build-column("old", is-old)` into the Interactions Area.
* Try typing `animals-table.build-column("sticker", nametag)` into the Interactions Area.
* What do you get? What do you think is going on?

The `.build-column` method walks through the table, applying whatever function it was given to each row. Whatever the function produces for that row becomes the value of our new column, which is named based on the string it was given. In the first example, we gave it the `is-old` function, so the new table had an extra Boolean column for every animal, indicating whether or not it was young. Notice that the Domain for `.build-column` says that the builder must be a function which consumes a `Row` and produces some other value. If it consumes anything besides a single `Row`, we'll get an error.}

@ifproglang{codap}{
* Open the `Transformer` plugin, and choose the transformer `Build Attribute.` Select `animals-dataset`. In the formula expression box, type `Age > 5`. Apply the transformer. What happens?
* This time, type `Species = “cat”`. What do you get? What do you think is going on?

The `Build Attribute` transformer walks through the table, applying whatever function it was given to each row. Whatever the function produces for that row becomes the value of our new column, which is named based on the string it was given. In the first example, we gave it `Age > 5`, so the new table had an extra Boolean column for every animal, indicating whether or not it was young.}


=== Synthesize
Debrief with students. Ask them if they can think of a situation where they would want to use this. Some ideas:

- A dataset about schools might include columns for how many students are in the school and how many of those students identify as multi-racial. But when comparing schools of different sizes, what we really want is a column showing what _percentage_ of students identify as multi-racial. We could use @ifproglang{pyret}{`.build-column`} @ifproglang{pyret}{`Build Attribute`} to compute that for every row in the table.
@ifproglang{pyret}{
- The animals shelter might want to print nametags for every animal. They could build a column using the `text` function to have every animal's name in big, purple letters.}
- A dataset from Europe might list everything in metric (centimeters, kilograms, etc), so we could build a column to convert that to imperial units (inches, pounds, etc).

Being able to define functions @ifproglang{codap}{(what we are doing when we apply transformers)} is a _huge_ upgrade in our ability to analyze data! But as a wise person once said, "with great power comes great responsibility"! Dropping all the dogs from our dataset might be a cute exercise in this class, but suppose we want to drop certain populations from a national census? Even a small programming error could erase millions of people, impact funding for things like roads and schools, etc.

@ifproglang{pyret}{Functions are a powerful tool, and the next two lessons are all about thinking in terms of functions and how to build them. In the next lesson, we'll learn how to view functions in three different ways. By making sure each representation matches the other two, it gives us a chance to check our work - twice! The lesson after that turns our attention back to Data Analysis, building functions specifically for analyzing our dataset.}


== Additional Exercises:
@ifproglang{pyret}{
@opt-printable-exercise{pages/what-table-do-we-get.adoc}
}
