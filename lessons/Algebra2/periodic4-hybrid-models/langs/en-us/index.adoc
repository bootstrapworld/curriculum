= Fitting Hybrid Models

@description{Students investigate how to combine the types of models they have already learned about. }

@lesson-prereqs{periodic3-fitting-models}

@keywords{periodic, period, amplitude, frequency}

[@lesson-intro-table]
|===

| Lesson Goals
| Students will be able to...

- Read and interpret real-world data, presented in a scatter plot
- Recognize periodic behavior in tables and graphs
- Model periodic relationships using functions


| Student-facing Lesson Goals
|

- Let's use Pyret to model periodic relationships in data.

| Materials
|[.materials-links]
@material-links

|===


== Hybrid Models

=== Overview
Students explore the historical data, discovering that there's a stronger pattern at work than seasonal periodicity: a linear pattern of rising @math{\text{CO}_2} over time. They try fitting a linear model first, then combine it with their periodic model to find a better fit.

=== Launch

Our `periodic` model fit the `recent-table` pretty well with an S-value of about 1.2ppm. Does that mean we can use it to predict carbon dioxide levels for other years?

@lesson-instruction{
- Let's see how well our model fits the @math{\text{CO}_2} data from 2010 to 2023.
- With your partner complete @printable-exercise{predicting-co2.adoc}.
}

@slidebreak

@QandA{
@Q{How does the shape of our model compare to the shape of the data from the `modern-table`?}
@A{Answers will vary. Sample responses may include:
 - While they both have a wave, they look pretty different!
 - The model undulates around a horizontal line and the data undulates around a diagonal line.
 - The y-intercepts are in completely different places.
}

@Q{What do the S-values tell us about how the error we expect for predictions made from our `periodic` model for the data in the `modern-table` compares to the error we expect for predictions made for the data in the `recent-table`?}
@A{It is much more significant!}
@Q{What are some problems you see with this model?}
@Q{Where does it fit the data best?}
@A{Within the range of the dataset that it was built on.}
@Q{Where does it fit the worst?}
@A{The farther we get from the date range it was built on.}
}

@slidebreak

@center{@image{images/modern-bad-fit.png}}

We can still see our model running along the top of the graph, but the data doesn't line up with the model _at all_ until about the end of 2022.

What do you think will happen if we try to fit this model to _all_ of our data? Try it out!

@slidebreak

It gets even worse!

@center{@image{images/historical-bad-fit.png}}

@QandA{
@Q{If our model is so bad at fitting historical data, why was it so good at fitting just the one year?}
@A{Models are only reliable within the span of the data they fit. The fact that the model fit `recent-table` well means it's a good model _for that year_, but we can't make any assumptions about dates outside of the range of the training data.}
}

=== Investigate
Let's just look at the historical data by itself, without worrying about models.

@center{@image{images/historical-scatter-plot.png}}
@lesson-instruction{
- In small groups, discuss what you Notice and Wonder about this plot.
- Be prepared to share back with the class!
}

@slidebreak

@lesson-instruction{
- Complete questions 1 and 2 on @printable-exercise{modeling-historical-co2.adoc}
}

@slidebreak

@ifslide{@right{@image{images/historical-scatter-plot.png}}}It looks like there are two different things going on here:

1. The amount of @math{\text{CO}_2} in the air _generally_ rises linearly over time, for a positive, linear relationship with the year.
2. But at the same time, there are seasonal, periodic variations that cause it to fluctuate up and down across that line.

@lesson-instruction{
- Do you think it's possible for a model to be both linear _and_ periodic?
- In small groups, see if you can come up with an idea for a function that combined the best of both models.
}

@teacher{Have students share their models and/or discuss their thinking.}

@slidebreak{InvestigateR-DN}

@lesson-instruction{
@ifslide{@right{@image{images/historical-scatter-plot.png}}}
- Complete as much of @printable-exercise{modeling-historical-co2.adoc} as you can.
}

@slidebreak

Our periodic model had two terms:

- The periodic term @math{4.13 \times sin(2\pi(x - 2023.1))}, which described the wave that wrapped around the horizontal midline
- The vertical shift @math{419.87}, which described the (fixed) y-coordinate of the midline

But when we zoomed out to see the historical @math{\text{CO}_2} data, we saw that the midline isn't horizontal at all!

@slidebreak

*The midline _is_ our linear model!*

By replacing the vertical shift term in our periodic model with the linear model, we get the best of both worlds! Linear behavior for the midline over the years, and periodic behavior for the seasonal variation in @math{\text{CO}_2}.

++++
<style>
/* Add custom CSS to make the math bold, and add coloring to nested circles */
.hybridmath .mathunicode { font-weight: bold !important; }
.hybridCOE .expression { background: white !important; }
.hybridCOE .expression .expression { background: aquamarine !important; }
.hybridCOE .expression .expression .expression { background: lightskyblue !important; }
.hybridCOE .expression .expression .expression .expression {
	background: lightyellow !important;
}
.hybridCOE .expression .expression .expression .expression .expression {
	background: lightpink !important;
}
</style>
++++
[.hybridmath]
@center{*@math{f(x) = 4.13 \times sin(2\pi(x - 2023.1)) + 1.8345x + -3296}*}

@slidebreak

We can visualize the body of the function using the Circles of Evaluation:

[.hybridCOE]
@show{(coe '(+ (* 4.13 (sin (* (* 2 PI) (- x 2023.1)))) (+ (* 1.8345 x) -3296) ))}

@lesson-instruction{
- If you haven't already defined your hybrid model, define it in the Definitions Area and finish @printable-exercise{modeling-historical-co2.adoc}.
- How much better is the @math{S} value of the hybrid model, compared to the purely-linear one?
}

=== Synthesize

- Why did our hybrid model fit better than the periodic or linear models alone?
- Look closely at where the hybrid model fits the data. When does the data _under_ or _over_ predict? What could this mean?
- What would a model look like for a disease like Covid, but with seasonal variations that cause minor peaks and valleys?

@strategy{Going Deeper}{
Have your students refer back to @lesson-link{exponential1-exploring-covid}. As with the `recent-table` table in @starter-file{alg2-co2}, the starter file there constrains the dataset to show only recent data. This is done for the same reason: to introduce students to a more perfectly-exponential model. Now that students know how to combine terms from different models, they can go back and build a model that fits the entire Covid dataset!
}
