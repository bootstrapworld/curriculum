= Fitting Hybrid Models

++++
<style>
/* Add custom CSS to make the math bold, and add coloring to nested circles */
.hybridmath .mathunicode { font-weight: bold !important; }
.hybridCOE { display: inline-block !important; }
.hybridCOE .circleevalsexp { width: unset; vertical-align: middle; }

.hybridCOE .expression { background: rgb(231 231 231) !important; }
.hybridCOE .expression .expression { background: white !important; }

/* Further customized CSS to make any nesting after level 2 50% opaque */
.first .expression > .value { background: white !important; }
.first .circleevalsexp > .expression > .expression > .expression { opacity: 0.5; }
</style>
++++

@description{Students investigate how to combine the types of models they have already learned about. }

@lesson-prereqs{periodic3-fitting-models}

@keywords{periodic, period, amplitude, frequency}

[@lesson-intro-table]
|===

| Lesson Goals
| Students will be able to...
@objectives

| Student-facing Lesson Goals
|

- Let's use Pyret to model periodic relationships in data.

| Materials
|[.materials-links]
@material-links

| Supplemental Materials
|[.materials-links]
@opt-material-links

|===

== Deconstructing Models
@objective{function-composition-programming}

=== Overview

Students explore the historical data, discovering that there's a stronger pattern at work than seasonal periodicity: a seemingly-linear pattern of rising @math{\text{CO}_2} over time. After considering why we ended up with a periodic model initially and how it connects to the larger trend in the data, they practice comparing @vocab{S-values} for the different models they've fit.

=== Launch
@slidebreak{Launch}

Sally sells lemonade for $1.25/cup. Each cup costs her $0.30 in ice, lemons, sugar, and cups. 

We can describe her `revenue`, `cost`, and `profit` as functions of glasses-sold.

@indented{
@math{\text{revenue}(g) = $1.25 \times g} +
@math{\text{cost}(g) = $0.30 \times g} +
@math{\text{profit}(g) = â€¦?}
}

@ifslide{@teacher{Advance to the next slide to discuss the profit function.}}

@slidebreak{Launch}

The `profit` function can be defined many ways that will return the correct answer! Here are a few.

@indented{
@math{\text{profitA}(g) = ($1.25 \times g) - ($0.30 \times g)} +
@math{\text{profitB}(g) = \text{revenue}(g) - \text{cost}(g)} +
@math{\text{profitC}(g) = ($1.25 - $0.30) \times g} +
@math{\text{profitD}(g) = $0.95 \times g}
}

@QandA{
@Q{Which of the `profit` definitions shown uses function composition? How do you know?}
@A{B. Because it makes use of the `revenue` and `cost` functions we already defined!}

@Q{Why would programmers prefer to define `profit` using function composition?}
@A{Smaller pieces are _easier to think about_, and to test!}
@A{Pieces can be _reused_!
* Like Lego pieces, smaller functions can be used to build all kinds of things.}
@A{Reusing code means _less code_ overall.
* Less code means fewer places to make (and fix) mistakes.}
@A{Reusing code means _less duplicate code_.
* When code needs to be changed, that change only needs to be made in one place, instead of in multiple places.}
}

@teacher{
If your students need some extra practice with function composition, you may find useful activities in our @lesson-link{function-composition} lesson.
}

@slidebreak{Launch-DN}

@lesson-instruction{
- Let's consider two periodic models built from the `recent-table` using cosine -- one with function composition, and the other without it.
- Complete the first section of @printable-exercise{choosing-the-best-model.adoc}, looking at functions defined in the @starter-file{alg2-hybrid}.
}

@slidebreak{Launch}

@indented{
```
fun periodic-cos(x): (4.13 * cos(6.28 * (x - 2023.35))) + 419.87 end 
fun wave-cos(x):     (4.13 * cos(6.28 * (x - 2023.35)))          end 
fun midline-cos(x):                                       419.87 end 
fun periodic-cos2(x):     wave-cos(x)      +      midline-cos(x) end
```
}

@QandA{
@Q{What is going on in `periodic-cos2` and why does it produce the same graph as `periodic-cos`?}
@A{`periodic-cos2` is composed of two functions called `midline-cos` and `wave-cos`:
  * `midline-cos` is just the vertical shift of the `periodic-cos` function.
  * `wave-cos` is all of the parts of the `periodic-cos` function except for that vertical shift.
}
}
@slidebreak{Launch}


@QandA{
@Q{What kind of line passed between the peaks and waves of our `periodic-cos` model?}
@A{horizontal}

@Q{How did that line get defined in our function definition?}
@A{Horizontal lines are defined by a single number -- the vertical shift.}
@A{The final term of our `periodic-cos` function definition is the number that defines the position of the horizontal line.}
}

@slidebreak{Launch}

Our `periodic-cos` model has two terms:

- The *periodic term* (@math{4.13 \times cos({6.28 \over 1}(x - 2023.35))}), which described the wave that wrapped around the horizontal midline
- The *vertical shift* (@math{419.87}), which described the (fixed) y-coordinate of the midline

Our `periodic-cos2` model splits these terms into _separate functions_, and then composes them:

[cols="^.^15a,^.^1a,^.^10a", frame="none", grid="none"]
|===
| [.hybridCOE.first]
@show{(coe '(+ (* 4.13 (cos (* 6.28 (- x 2023.1)))) 419.87))}

| &rarr;

| [.hybridCOE.second]
@show{(coe '(+ (wave-cos x) (midline-cos x)))}
|===
@slidebreak{Launch}

@lesson-instruction{
- Let's take a moment to refresh ourselves on the models we've seen so far.
- Turn to the second section of @printable-exercise{choosing-the-best-model.adoc} with your partner. To complete the table:
  * make a sketch of each model type
  * list the key characteristics of each model type
- Then complete the last two questions on the page.
}

=== Investigate
@slidebreak{Investigate}

The scatter plot we just looked at on @printable-exercise{choosing-the-best-model.adoc} was generated from @math{\text{CO}_2} data, but had a very different shape from our `periodic-sin` model! That's because we built our `periodic-sin` model using @math{\text{CO}_2} data from the `recent-table`, which focuses on a small window: _just one year_. And the scatter plot was made from the `modern-table`, which includes historical @math{\text{CO}_2} levels from the thirteen-year span from 2010 to 2023. Let's take a closer look!


@slidebreak{Investigate-DN}

@lesson-instruction{
- Return to the @starter-file{alg2-hybrid}.
- Make a scatter plot of @math{\text{CO}_2} over time for the `modern-table`, which includes historical @math{\text{CO}_2} levels from 2010 to 2023.
- What do you Notice? What do you Wonder?
}

@ifslide{@teacher{Proceed to the next slide, which includes the scatter plot, before discussing Notices and Wonders.}}

@slidebreak{InvestigateC}

@center{@image{images/modern-co2-scatter.png, 500}}

@QandA{
@Q{Why might somebody describe the shape of this data as @vocab{linear}?}
@A{Because we could draw a diagonal line with a positive slope through the middle of the wave and it would do a pretty good job of summarizing the trend.}
@Q{Why might somebody describe the shape of this data as @vocab{periodic}?}
@A{Because there is a consistent wave that goes up and down in regular intervals.}
}

@slidebreak{Investigate-DN}

@lesson-instruction{
- In the @starter-file{alg2-hybrid}, find the code where you're asked to "Define your periodic-sin functions..."
  * Define `periodic-sin` to be the model *you* found using Desmos (which you already defined in @opt-starter-file{alg2-co2} and on @lesson-link{periodic3-fitting-models/pages/modeling-recent-co2-2.adoc}).
- Work with your partner to complete @printable-exercise{modeling-modern-co2.adoc} by:
  * fitting an optimal linear model to the `modern-table`
  * fitting `periodic-sin` to the `modern-table`
  * imagining the best possible model for the `modern-table`
}

@slidebreak{Investigate}

[cols="^1a,^1a", options="header"]
|===
| Optimal Linear Model			| Our Periodic Model
|@image{images/modern-lr.png}	|@image{images/modern-co2-model-soln.png}
|===

@QandA{
@Q{How would you describe how the `linear-modern` model fit our `modern-table` data?}
@A{The @vocab{linear regression} plot shows the @vocab{line of best fit} passing through the middle of the diagonal wave of points.}

@Q{How would you describe how our `periodic-sin` model fits the shape of the data from the `modern-table`?}
@A{Answers will vary. Make sure discussion addresses residuals. Sample responses may include:
 * While they both have a wave, they look pretty different!
 * The model undulates around a horizontal line and the data undulates around a diagonal line.
 * The y-intercepts are in completely different places.
 * When we fit the `periodic-sin` model to the data we see the model as a horizontal wave at the top, eventually lining up with the points on the right hand side of the graph.
 * We also see vertical residuals showing the distance between each data point and the model.
}
}

@slidebreak{InvestigateC}

@ifslide{@image{images/modern-co2-model-soln.png,350}}

@QandA{
@Q{Where does the `periodic-sin` model fit the `modern-table` data *best*?}
@A{Within the range of the dataset that it was built on.}
@Q{Where does the `periodic-sin` model fit the `modern-table` data *worst*?}
@A{The farther we get from the date range it was built on.}
}

@slidebreak{Investigate}

@QandA{
@Q{How would you describe the shape of the model you drew that would be optimal?}
@A{Hopefully students will describe a wave whose midline is diagonal.}
}

=== Synthesize
@slidebreak{Synthesize}

@QandA{
@Q{We built the `periodic-sin` model to fit the data in the `recent-table`. Why doesn't it do a good job of predicting @math{CO_2} levels for a larger time frame?}
@A{Models are only reliable within the span of the data from which they were created. The fact that the model fit `recent-table` well means it's a good model for the data in _that year_, but we can't make any assumptions about dates outside of the range of the training data.}
}

== Hybrid Models

=== Overview

Students explore the possibility that a model could combine various kinds of models and use function composition to define functions from other functions.

@teacher{
We've chosen to describe these models as hybrid in order to make it accessible to students, but this is not a mathematical term. If you're looking to connect this lesson to related materials, polynomial functions and/or function addition are terms that might turn up relevant reading. 
}

=== Launch
@slidebreak{LaunchR}

@ifslide{@right{@image{images/historical-scatter-plot.png}}} 
When we zoom out to see the historical @math{\text{CO}_2} data, we see that there are two different things going on:

1. The amount of @math{\text{CO}_2} in the air _generally_ rises over time, for a positive, linear relationship with the year.
2. There are seasonal, periodic variations that cause @math{\text{CO}_2} to fluctuate up and down across that line.

The wave is following a diagonal line... {nbsp}so the midline for our model shouldn't be horizontal at all!  

@slidebreak{Launch}

@lesson-instruction{
- *Is it possible for a model to be both linear _and_ periodic?*
- Return to the @starter-file{alg2-hybrid}. 
- Make sure that you and your partner have:
  * defined the wave and midline of your `periodic-sin` model as separate functions
  * recombined them in `periodic-sin2` using function composition (you can refer to the example of `periodic-cosine` if necessary)
- Test out your `periodic-sin2` model with `recent-table` to confirm that it still fits as well as the original model!
  * If it doesn't look exactly like the `periodic-sin` model, check your code carefully!
- Then, complete @printable-exercise{hybrid.adoc}.
}

@slidebreak{Launch}

@QandA{
@Q{What line should our model wrap around?}
@A{Our line of best fit!}

@Q{What happens when you fit your `hybrid-modern` model to the `modern-table` data?}
@A{The model should now look like waves along a diagonal.}

@Q{How much less error do we expect from predictions made with `hybrid-modern` than with `linear-modern`?}
@A{38%}
}

@slidebreak{Launch}

By replacing the @vocab{midline} term (vertical shift) in our periodic model with the linear model from `lr-plot`, we get the best of both worlds:

- Linear behavior for the midline representing the long-term trend...
- Periodic behavior for the seasonal variation in @math{\text{CO}_2}

[cols="^1a" grid="none", frame="none", stripes="none"]
|===
| [.hybridmath]
@big{*@math{f(x) = 4.13 \times sin(\frac{6.28}{1}(x - 2023.1)) + (1.8345x + -3296)}*}

|
[.hybridCOE]
@show{(coe '(+ (wave-sin x) (linear-modern x)))}
|===

@slidebreak{Launch}

We can visualize the body of the function using the Circles of Evaluation.

@lesson-instruction{
- Now that you know how to build a hybrid model, let's have you try building one on your own! 
- Turn to @printable-exercise{more-hybrid.adoc} and build a hybrid model for the full @math{\text{CO}_2} data.
}

=== Synthesize
@slidebreak{Synthesize}

@QandA{
@Q{Why did our hybrid model fit better than the periodic or linear models alone?}
@A{Because it captures both the overarching trend and the seasonal trend.}

@Q{Why doesn't it make sense to compare the following @vocab{S-values}?
 
* the error we expect for predictions made from our `periodic-sin` model with the data in the `modern-table`
* the error we expect for predictions made from our `periodic-sin` model with the data in the `recent-table`
}
@A{The datasets have completely different ranges!}
}

@ifnotslide{
@strategy{Going Deeper}{
- If students look carefully at the fit of their hybrid periodic model to the `co2-table`, they'll see that the model _under-predicts_ at the beginning of the graph, then _over-predicts_ in the middle, the _under-predicts_ again at the end. Is it possible that there's an _even-better_ hybrid model, which mixes periodic growth with something other than linear?
- Have your students refer back to @lesson-link{exponential1-exploring-covid}. As with the `recent-table` table in @starter-file{alg2-hybrid}, the starter file there constrains the dataset to show only recent data. This is done for the same reason: to introduce students to a more perfectly-exponential model. Now that students know how to combine terms from different models, they can go back and build a model that fits the entire Covid dataset!
}
}

